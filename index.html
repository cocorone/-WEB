<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // 注意: signInWithCustomTokenは不要になりました
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // あなたのウェブアプリのFirebase設定
    const firebaseConfig = {
        apiKey: "AIzaSyDbQiwT1_DJhoPdV-HRFkN0QM1MC08trJc",
        authDomain: "cocorone-f0ea6.firebaseapp.com",
        projectId: "cocorone-f0ea6",
        storageBucket: "cocorone-f0ea6.firebasestorage.app",
        messagingSenderId: "609967939636",
        appId: "1:609967939636:web:ef26d301b9edc37dbcaa61",
        measurementId: "G-6FH0X32X6H" // これはAnalytics用なので、カウンター動作には直接影響しませんが、含めても問題ありません
    };

    const app = initializeApp(firebaseConfig); // Firebaseの初期化
    // const analytics = getAnalytics(app); // カウンターには不要なので削除してもOK

    // カウンターが使用するappIdはprojectIdとする
    const appId = firebaseConfig.projectId; // ★追加・修正
    // const initialAuthToken = null; // ★これは不要なので削除します (CustomToken認証は使いません)

    let db;
    let auth;

    // Firebaseの初期化と認証
    const initializeFirebase = async () => {
        try {
            // appは上でinitializeApp済みなので、ここでは不要
            db = getFirestore(app); // appを引数に渡す
            auth = getAuth(app); // appを引数に渡す

            await signInAnonymously(auth); // 匿名認証を使用
            console.log('Firebase: Signed in anonymously.');

        } catch (error) {
            console.error("Firebaseの初期化または認証エラー:", error);
            document.getElementById('viewCount').textContent = 'エラー';
        }
    };

    // カウンターの更新処理
    const updateCounter = async () => {
        if (!db) {
            console.error("Firestoreが初期化されていません。");
            document.getElementById('viewCount').textContent = 'エラー';
            return;
        }

        // Firestoreのパスを修正: appIdの代わりにfirebaseConfig.projectIdを使用
        const counterRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'web_counters', 'main_counter'); // ★修正

        let currentCount = 0;

        try {
            // ... (この後のコードは変更なし) ...
        } catch (error) {
            console.error("カウンターの更新エラー:", error);
            document.getElementById('viewCount').textContent = 'エラー';
        }
    };

    // ページ読み込み時にFirebaseを初期化し、カウンターを更新
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeFirebase();
        // 匿名認証は常に成功すると仮定して、認証チェックは簡略化
        await updateCounter();
    });
</script>
